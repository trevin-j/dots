#!/usr/bin/env bash
set -euo pipefail

# -----------------------------
# Wayland session runner
# -----------------------------
# Runs a command through the compositor so it's independent of cwd/env
session_run() {
    local cmd="$*"
    hyprctl dispatch exec "$cmd"
    # Later, you can detect Sway or other compositors and modify here
}

# -----------------------------
# Common fzf wrapper
# -----------------------------
fzf_picker() {
    fzf \
        --prompt="❯ " \
        --layout=reverse \
        --border \
        --ansi \
        "$@"
}

# -----------------------------
# App launcher picker
# -----------------------------
launch_picker() {
    local dirs=(/usr/share/applications ~/.local/share/applications)

    choice=$(fzf_picker \
        --delimiter=$'\t' \
        --with-nth=1 \
        --prompt="❯ Launch " \
        --preview='echo "Desktop file: {2}"' \
        < <(
            for dir in "${dirs[@]}"; do
                [ -d "$dir" ] || continue
                for file in "$dir"/*.desktop; do
                    [ -f "$file" ] || continue
                    grep -q '^NoDisplay=true' "$file" && continue
                    name=$(grep -m1 '^Name=' "$file" | cut -d= -f2-)
                    [ -n "$name" ] || continue
                    printf '%s\t%s\n' "$name" "$file"
                done
            done
        )
    )

    [ -z "$choice" ] && exit 0

    local desktop_file
    desktop_file=$(cut -f2 <<<"$choice")

    session_run "gio launch '$desktop_file'"
}

# -----------------------------
# Clipboard history picker
# -----------------------------
cliphist_picker() {
    local choice

    choice=$(fzf_picker \
        --prompt="❯ Clipboard history " \
        --no-sort \
        --preview='cliphist decode {1} | head -100' \
        --delimiter=$'\t' \
        --with-nth=2 \
        < <(cliphist list)
    )

    [ -z "$choice" ] && exit 0

    session_run "cliphist decode \"$choice\" | sed -z 's/\n$//' | wtype -"
}

# -----------------------------
# Main dispatcher
# -----------------------------
main() {
    local cmd="${1:-launch}"  # default to launch
    shift || true

    case "$cmd" in
        launch)
            launch_picker "$@"
            ;;
        cliphist)
            cliphist_picker "$@"
            ;;
        *)
            echo "Unknown subcommand: $cmd" >&2
            exit 1
            ;;
    esac
}

main "$@"

