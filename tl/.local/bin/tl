#!/usr/bin/env bash
set -euo pipefail

# -----------------------------
# Wayland session runner
# -----------------------------
# Runs a command through the compositor so it's independent of env
# This is important because if this script is run from a brand new terminal,
# anything that needs to spawn a gui or use the session in any way will fail.
session_run() {
    local cmd="$*"
    hyprctl dispatch exec "$cmd"
    # Support for Swar and other compositors could be added here
}

# -----------------------------
# Common fzf wrapper
# -----------------------------
fzf_picker() {
    fzf \
        --prompt="❯ " \
        --layout=reverse \
        --border \
        --ansi \
        "$@"
}

# -----------------------------
# App launcher picker
# -----------------------------
launch_picker() {
    local dirs=(/usr/share/applications ~/.local/share/applications)

    choice=$(fzf_picker \
        --delimiter=$'\t' \
        --with-nth=1 \
        --prompt="❯ Launch " \
        --preview='echo "Desktop file: {2}"' \
        < <(
            for dir in "${dirs[@]}"; do
                [ -d "$dir" ] || continue
                for file in "$dir"/*.desktop; do
                    [ -f "$file" ] || continue
                    grep -q '^NoDisplay=true' "$file" && continue
                    name=$(grep -m1 '^Name=' "$file" | cut -d= -f2-)
                    [ -n "$name" ] || continue
                    printf '%s\t%s\n' "$name" "$file"
                done
            done
        )
    )

    [ -z "$choice" ] && exit 0

    local desktop_file
    desktop_file=$(cut -f2 <<<"$choice")

    session_run "gio launch '$desktop_file'"
}

# -----------------------------
# Clipboard history picker
# -----------------------------
cliphist_picker() {
    local choice

    choice=$(fzf_picker \
        --prompt="❯ Clipboard history " \
        --no-sort \
        --preview='cliphist decode {1} | head -100' \
        --delimiter=$'\t' \
        --with-nth=2 \
        < <(cliphist list)
    )

    [ -z "$choice" ] && exit 0

    session_run "cliphist decode \"$choice\" | sed -z 's/\n$//' | wtype -"
}

# ----------------------------- 
# Bitwarden password picker
# -----------------------------
bw_ensure_ready() {
    if rbw login >/dev/null 2>&1; then
        return 0
    fi

    echo "Bitwarden not ready. Signing in..."

    read -rp "Email: " email
    [ -z "$email" ] && return 1

    read -rp "Base URL (optional): " base_url
    read -rp "Identity URL (optional): " identity_url

    rbw config set email "$email"

    [ -n "$base_url" ] && rbw config set base_url "$base_url"
    [ -n "$identity_url" ] && rbw config set identity_url "$identity_url"

    # Set to a tty pinentry so it all stays in the terminal rather than popping up a gui
    rbw config set pinentry pinentry-tty

    if ! rbw login; then
        echo "Bitwarden sync failed" >&2
        return 1
    fi
}

bw_picker() {
    bw_ensure_ready || return 1

    local choice

    choice=$(rbw ls |
        fzf_picker \
            --prompt="❯ Bitwarden " \
    )

    [ -z "$choice" ] && return 0

    session_run "rbw get \"$choice\" | sed -z 's/\n$//' | wtype -"
}

# -----------------------------
# Power menu
# -----------------------------
power_picker() {
    local choice

    choice=$(
        printf '%s\n' \
            "  Lock" \
            "󰤄  Suspend" \
            "󰍃  Logout" \
            "󰜉  Reboot" \
            "󰐥  Shutdown" |
        fzf_picker \
            --prompt="❯ Power " \
            --no-sort
    )

    [ -z "$choice" ] && return 0

    case "$choice" in
        *Lock)
            loginctl lock-session
            ;;
        *Suspend)
            systemctl suspend
            ;;
        *Logout)
            hyprctl dispatch exit
            ;;
        *Reboot)
            systemctl reboot
            ;;
        *Shutdown)
            systemctl poweroff
            ;;
    esac
}


# -----------------------------
# Main dispatcher
# -----------------------------
main() {
    local cmd="${1:-launch}"  # default to launch
    shift || true

    case "$cmd" in
        launch)
            launch_picker "$@"
            ;;
        cliphist)
            cliphist_picker "$@"
            ;;
        bitwarden)
            bw_picker "$@"
            ;;
        power)
            power_picker "$@"
            ;;
        *)
            echo "Unknown subcommand: $cmd" >&2
            exit 1
            ;;
    esac
}

main "$@"

