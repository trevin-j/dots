#!/usr/bin/env bash
set -euo pipefail

# -----------------------------
# Wayland session runner
# -----------------------------
# Runs a command through the compositor so it's independent of env
# This is important because if this script is run from a brand new terminal,
# anything that needs to spawn a gui or use the session in any way will fail.
session_run() {
    local cmd="$*"
    hyprctl dispatch exec "$cmd"
    # Support for Swar and other compositors could be added here
}

# -----------------------------
# Common fzf wrapper
# -----------------------------
fzf_picker() {
    fzf \
        --prompt="❯ " \
        --layout=reverse \
        --border \
        --ansi \
        "$@"
    }

# -----------------------------
# Generic MRU frequency sorter
# -----------------------------
mru_sort() {
    local mru_file="$1"
    shift
    # Read items from stdin, output sorted with MRU frequency
    awk -v mru="$mru_file" '
        BEGIN {
            # Count frequency of each item in MRU file
            while ((getline line < mru) > 0) freq[line]++
        }
        {
            key = $1
            sortval = (key in freq) ? -freq[key] : 0
            print sortval "\t" $0
        }
    ' | sort -k1,1n | cut -f2-
}

# -----------------------------
# App launcher picker
# -----------------------------
launch_picker() {
    local dirs=(/usr/share/applications ~/.local/share/applications)

    choice=$(fzf_picker \
        --delimiter=$'\t' \
        --with-nth=1 \
        --prompt="❯ Launch " \
        --preview='echo "Desktop file: {2}"' \
        < <(
            for dir in "${dirs[@]}"; do
                [ -d "$dir" ] || continue
                for file in "$dir"/*.desktop; do
                    [ -f "$file" ] || continue
                    grep -q '^NoDisplay=true' "$file" && continue
                    name=$(grep -m1 '^Name=' "$file" | cut -d= -f2-)
                    [ -n "$name" ] || continue
                    printf '%s\t%s\n' "$name" "$file"
                done
            done
        )
    )

    [ -z "$choice" ] && exit 0

    local desktop_file
    desktop_file=$(cut -f2 <<<"$choice")

    session_run "gio launch '$desktop_file'"
}

# -----------------------------
# Clipboard history picker
# -----------------------------
cliphist_picker() {
    local choice

    choice=$(fzf_picker \
        --prompt="❯ Clipboard history " \
        --preview='cliphist decode {1} | head -100' \
        --delimiter=$'\t' \
        --with-nth=2 \
        < <(cliphist list)
    )

    [ -z "$choice" ] && exit 0

    session_run "cliphist decode \"$choice\" | sed -z 's/\n$//' | wtype -"
}

# ----------------------------- 
# Bitwarden password picker
# -----------------------------
bw_ensure_ready() {
    if rbw login >/dev/null 2>&1; then
        rbw unlock
        return 0
    fi

    echo "Bitwarden not ready. Signing in..."

    read -rp "Email: " email
    [ -z "$email" ] && return 1

    read -rp "Base URL (optional): " base_url
    read -rp "Identity URL (optional): " identity_url

    rbw config set email "$email"

    [ -n "$base_url" ] && rbw config set base_url "$base_url"
    [ -n "$identity_url" ] && rbw config set identity_url "$identity_url"

    # Set to a tty pinentry so it all stays in the terminal rather than popping up a gui
    rbw config set pinentry pinentry-tty

    if ! rbw login; then
        echo "Bitwarden sync failed" >&2
        return 1
    fi
}

bw_picker() {
    bw_ensure_ready || return 1

    local opt
    opt="${1:---password}"
    local prompt
    prompt=${opt//--/}
    prompt="${prompt^}"

    local previewer
    previewer='rbw get {} --raw 2>/dev/null | jq -r "
        . as \$item |
        [
            \$item.name,
            (\$item.folder // \"No Folder\"),
            (\$item.data.username // \"No Username\"),
            (if \$item.data.totp? then \"Has TOTP\" else empty end),
            \"URIs:\",
            (\$item.data.uris // [] | map(\" - \" + .uri) | join(\"\n\")),
            (\$item.notes // empty)
        ] | join(\"\n\")"
    '

    local choice

    if [[ "$opt" == "--totp" ]]; then
        choice=$(
            fzf_picker --prompt="❯ Bitwarden TOTP Code " --preview="$previewer" < <(
                entries=$(rbw ls)
                printf '%s\n' "$entries" | xargs -P 8 -I{} sh -c '
                json=$(rbw get "{}" --raw 2>/dev/null) || exit 0
                echo "$json" | jq -r "select(.data.totp? != null) | .name"
                '
            )
        )
    else
        choice=$(
            rbw ls |
                fzf_picker --prompt="❯ Bitwarden $prompt " --preview="$previewer"
            )
    fi

    local rbw_cmd
    case "$opt" in
        --password)
            rbw_cmd="rbw get \"$choice\""
            ;;
        --totp)
            rbw_cmd="rbw totp \"$choice\""
            ;;
        --username)
            rbw_cmd="rbw get \"$choice\" --raw | jq -r '.data.username'"
            ;;
        *)
            echo "Unknown option: $opt" >&2
            return 1
            ;;
    esac

    session_run "$rbw_cmd | sed -z 's/\n$//' | wtype -"
}

# -----------------------------
# Emoji picker
# -----------------------------
emoji_picker() {
    local data_file="$HOME/.local/share/tl/emoji.json"
    local mru_file="$HOME/.local/share/tl/emoji-mru"

    # Build fzf input (glyph + label)
    local fzf_input
    fzf_input=$(jq -r '
        .[] | ([.unicode, .label] | @tsv),
        (.skins[]? | [.unicode, .label] | @tsv)
    ' "$data_file" | mru_sort "$mru_file")

    # Launch fzf picker
    local choice
    choice=$(printf "%s\n" "$fzf_input" |
        fzf_picker \
            --prompt="❯ Emoji " \
            --delimiter=$'\t' \
            --with-nth=1,2
    )

    [ -z "$choice" ] && return 0

    local emoji_glyph
    emoji_glyph=$(cut -f1 <<<"$choice")

    # Insert emoji
    session_run "printf '%s' '$emoji_glyph' | wtype -"

    # Update MRU: append to file
    printf '%s' "$emoji_glyph" >> "$mru_file"
}

# -----------------------------
# Nerd Font Icon Picker
# -----------------------------
nerdfont_picker() {
    local data_file="$HOME/.local/share/tl/nerd-font-icons.json"
    local mru_file="$HOME/.local/share/tl/nerdfont-mru"

    # Build fzf input: glyph + name
    local fzf_input
    fzf_input=$(jq -r 'to_entries[] | [.value.char, .key] | @tsv' "$data_file" | mru_sort "$mru_file")

    # Launch fzf picker
    local choice
    choice=$(printf "%s\n" "$fzf_input" |
        fzf_picker \
            --prompt="❯ Nerd Font " \
            --delimiter=$'\t' \
            --with-nth=1,2
    )

    [ -z "$choice" ] && return 0

    local glyph
    glyph=$(cut -f1 <<<"$choice")

    # Insert into focused window
    session_run "printf '%s' '$glyph' | wtype -"

    # Update MRU frequency
    printf '%s' "$glyph" >> "$mru_file"
}

# -----------------------------
# Power menu
# -----------------------------
power_picker() {
    local choice

    choice=$(
        printf '%s\n' \
            "  Lock" \
            "󰤄  Suspend" \
            "󰒲  Hibernate" \
            "󰍃  Logout" \
            "󰜉  Reboot" \
            "󰐥  Shutdown" |
            fzf_picker \
            --prompt="❯ Power "
        )

        [ -z "$choice" ] && return 0

        case "$choice" in
            *Lock)
                loginctl lock-session
                ;;
            *Suspend)
                systemctl suspend
                ;;
            *Hibernate)
                systemctl hibernate
                ;;
            *Logout)
                hyprctl dispatch exit
                ;;
            *Reboot)
                systemctl reboot
                ;;
            *Shutdown)
                systemctl poweroff
                ;;
        esac
    }


# -----------------------------
# Main dispatcher
# -----------------------------
main() {
    local cmd="${1:-launch}"  # default to launch
    shift || true

    case "$cmd" in
        launch)
            launch_picker "$@"
            ;;
        cliphist)
            cliphist_picker "$@"
            ;;
        bitwarden)
            bw_picker "$@"
            ;;
        emoji)
            emoji_picker "$@"
            ;;
        nerdfont)
            nerdfont_picker "$@"
            ;;
        power)
            power_picker "$@"
            ;;
        *)
            echo "Unknown subcommand: $cmd" >&2
            exit 1
            ;;
    esac
}

main "$@"

